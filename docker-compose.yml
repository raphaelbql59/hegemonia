version: '3.8'

services:
  # Serveur Minecraft Fabric
  minecraft:
    image: itzg/minecraft-server:java17
    container_name: hegemonia-minecraft
    ports:
      - "25565:25565"
    volumes:
      - ./server:/data
      - ./mods:/data/mods
    environment:
      EULA: "TRUE"
      TYPE: "FABRIC"
      VERSION: "1.20.1"
      MEMORY: "16G"
      MAX_MEMORY: "16G"
      INIT_MEMORY: "8G"
      JVM_OPTS: "-XX:+UseG1GC -XX:+ParallelRefProcEnabled -XX:MaxGCPauseMillis=200 -XX:+UnlockExperimentalVMOptions -XX:+DisableExplicitGC -XX:G1NewSizePercent=30 -XX:G1MaxNewSizePercent=40 -XX:G1HeapRegionSize=8M -XX:G1ReservePercent=20 -XX:G1HeapWastePercent=5 -XX:G1MixedGCCountTarget=4 -XX:InitiatingHeapOccupancyPercent=15 -XX:G1MixedGCLiveThresholdPercent=90 -XX:G1RSetUpdatingPauseTimePercent=5 -XX:SurvivorRatio=32 -XX:+PerfDisableSharedMem -XX:MaxTenuringThreshold=1"
      ENABLE_RCON: "true"
      RCON_PASSWORD: "hegemonia2024"
      RCON_PORT: 25575
      SERVER_NAME: "Hegemonia - Earth Nations Server"
      MOTD: "§6Hegemonia §7| §eEarth Nations RP Server"
      DIFFICULTY: "hard"
      MAX_PLAYERS: 100
      VIEW_DISTANCE: 10
      SIMULATION_DISTANCE: 8
      ONLINE_MODE: "true"
      ENABLE_WHITELIST: "true"
    restart: unless-stopped
    networks:
      - hegemonia-network

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: hegemonia-db
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./api/prisma/init.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      POSTGRES_USER: hegemonia
      POSTGRES_PASSWORD: hegemonia_secure_2024
      POSTGRES_DB: hegemonia
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
    restart: unless-stopped
    networks:
      - hegemonia-network

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: hegemonia-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --requirepass hegemonia_redis_2024
    restart: unless-stopped
    networks:
      - hegemonia-network

  # Backend API
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: hegemonia-api
    ports:
      - "3000:3000"
    volumes:
      - ./api:/app
      - /app/node_modules
    environment:
      NODE_ENV: production
      DATABASE_URL: "postgresql://hegemonia:hegemonia_secure_2024@postgres:5432/hegemonia"
      REDIS_URL: "redis://:hegemonia_redis_2024@redis:6379"
      JWT_SECRET: "hegemonia_jwt_secret_change_in_production"
      RCON_HOST: "minecraft"
      RCON_PORT: 25575
      RCON_PASSWORD: "hegemonia2024"
      PORT: 3000
    depends_on:
      - postgres
      - redis
      - minecraft
    restart: unless-stopped
    networks:
      - hegemonia-network

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: hegemonia-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - hegemonia-network

volumes:
  postgres-data:
  redis-data:

networks:
  hegemonia-network:
    driver: bridge
